<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Neuron â€” Local AI Chat</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet" />
    <style>
        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” RESET & BASE â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
          --bg:        #0d0a07;
          --surface:   #141009;
          --surface2:  #1c160e;
          --border:    rgba(200,140,60,0.12);
          --border2:   rgba(200,140,60,0.22);
          --accent:    #f97316;
          --accent2:   #fdba74;
          --accent-glow: rgba(249,115,22,0.25);
          --text:      #f0ebe4;
          --text-dim:  #9a8a72;
          --text-faint:#4a3a28;
          --user-bg:   #2a1a08;
          --user-border: rgba(249,115,22,0.35);
          --ai-bg:     #110e09;
          --ai-border: rgba(200,140,60,0.15);
          --error:     #f87171;
          --success:   #6ee7b7;
          --r: 16px;
          --r-sm: 10px;
          --font-display: 'DM Serif Display', Georgia, serif;
          --font-body: 'DM Sans', sans-serif;
          --font-mono: 'DM Mono', 'Fira Code', monospace;
        }

        html, body {
          height: 100%;
          background: var(--bg);
          color: var(--text);
          font-family: var(--font-body);
          font-size: 15px;
          line-height: 1.65;
          overflow: hidden;
        }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” BACKGROUND ATMOSPHERE â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        body::before {
          content: '';
          position: fixed;
          inset: 0;
          background:
            radial-gradient(ellipse 80% 60% at 15% 0%, rgba(220,100,20,0.07) 0%, transparent 60%),
            radial-gradient(ellipse 60% 50% at 85% 100%, rgba(200,80,10,0.05) 0%, transparent 55%);
          pointer-events: none;
          z-index: 0;
        }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” LAYOUT â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        #app {
          position: relative;
          z-index: 1;
          display: grid;
          grid-template-columns: 260px 1fr;
          grid-template-rows: 100vh;
          height: 100vh;
        }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” SIDEBAR â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        #sidebar {
          background: var(--surface);
          border-right: 1px solid var(--border);
          display: flex;
          flex-direction: column;
          padding: 0;
          overflow: hidden;
          position: relative;
        }

        .sidebar-header {
          padding: 28px 22px 20px;
          border-bottom: 1px solid var(--border);
          flex-shrink: 0;
        }

        .logo {
          display: flex;
          align-items: center;
          gap: 10px;
          margin-bottom: 4px;
        }

        .logo-icon {
          width: 32px;
          height: 32px;
          background: linear-gradient(135deg, var(--accent), #fb923c);
          border-radius: 8px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 16px;
          box-shadow: 0 0 18px var(--accent-glow);
          flex-shrink: 0;
        }

        .logo-text {
          font-family: var(--font-display);
          font-size: 22px;
          color: var(--text);
          letter-spacing: -0.5px;
        }

        .logo-sub {
          font-size: 11px;
          color: var(--text-dim);
          letter-spacing: 0.5px;
          text-transform: uppercase;
          font-weight: 400;
          padding-left: 42px;
        }

        .sidebar-section {
          padding: 16px 14px 8px;
          font-size: 10px;
          text-transform: uppercase;
          letter-spacing: 1.2px;
          color: var(--text-faint);
          font-weight: 500;
        }

        .new-chat-btn {
          margin: 14px 14px 6px;
          padding: 10px 14px;
          background: transparent;
          border: 1px solid var(--border2);
          border-radius: var(--r-sm);
          color: var(--text-dim);
          font-family: var(--font-body);
          font-size: 13px;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: all 0.2s;
          width: calc(100% - 28px);
        }
        .new-chat-btn:hover {
          border-color: var(--accent);
          color: var(--accent2);
          background: rgba(249,115,22,0.06);
        }
        .new-chat-btn svg { opacity: 0.7; }

        .chat-list {
          flex: 1;
          overflow-y: auto;
          padding: 4px 8px;
          scrollbar-width: thin;
          scrollbar-color: var(--text-faint) transparent;
        }

        .chat-item {
          padding: 9px 12px;
          border-radius: var(--r-sm);
          cursor: pointer;
          font-size: 13px;
          color: var(--text-dim);
          transition: all 0.15s;
          margin-bottom: 2px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          display: flex;
          align-items: center;
          gap: 8px;
        }
        .chat-item:hover { background: var(--surface2); color: var(--text); }
        .chat-item.active { background: rgba(249,115,22,0.12); color: var(--accent2); border: 1px solid rgba(249,115,22,0.18); }
        .chat-item .ci-icon { font-size: 12px; opacity: 0.6; flex-shrink: 0; }
        .chat-item .ci-label { overflow: hidden; text-overflow: ellipsis; }

        .sidebar-footer {
          padding: 14px;
          border-top: 1px solid var(--border);
          flex-shrink: 0;
        }

        /* Model selector */
        .model-selector-wrap {
          position: relative;
        }
        .model-selector-label {
          font-size: 10px;
          text-transform: uppercase;
          letter-spacing: 1px;
          color: var(--text-faint);
          margin-bottom: 6px;
        }
        #modelSelect {
          width: 100%;
          background: var(--surface2);
          border: 1px solid var(--border);
          border-radius: var(--r-sm);
          color: var(--text-dim);
          font-family: var(--font-mono);
          font-size: 12px;
          padding: 8px 10px;
          cursor: pointer;
          outline: none;
          transition: border-color 0.2s;
          appearance: none;
          -webkit-appearance: none;
        }
        #modelSelect:focus { border-color: var(--accent); }

        /* Status indicator */
        .status-bar {
          display: flex;
          align-items: center;
          gap: 7px;
          margin-top: 10px;
          font-size: 11px;
          color: var(--text-faint);
        }
        .status-dot {
          width: 6px; height: 6px;
          border-radius: 50%;
          background: var(--text-faint);
          transition: all 0.3s;
        }
        .status-dot.online { background: var(--success); box-shadow: 0 0 6px var(--success); }
        .status-dot.error { background: var(--error); }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” MAIN AREA â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        #main {
          display: flex;
          flex-direction: column;
          overflow: hidden;
          position: relative;
        }

        /* Top bar */
        #topbar {
          padding: 18px 28px;
          border-bottom: 1px solid var(--border);
          display: flex;
          align-items: center;
          justify-content: space-between;
          flex-shrink: 0;
          background: rgba(10,10,15,0.8);
          backdrop-filter: blur(12px);
        }

        .topbar-title {
          font-family: var(--font-display);
          font-size: 18px;
          color: var(--text);
          letter-spacing: -0.3px;
        }
        .topbar-title span { color: var(--accent2); font-style: italic; }

        .topbar-actions {
          display: flex;
          align-items: center;
          gap: 10px;
        }

        .icon-btn {
          width: 34px; height: 34px;
          background: transparent;
          border: 1px solid var(--border);
          border-radius: 8px;
          color: var(--text-dim);
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.18s;
          font-size: 15px;
        }
        .icon-btn:hover { border-color: var(--border2); color: var(--text); background: var(--surface2); }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” MESSAGES â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        #messages {
          flex: 1;
          overflow-y: auto;
          padding: 24px 0;
          scrollbar-width: thin;
          scrollbar-color: var(--text-faint) transparent;
        }

        #messages::-webkit-scrollbar { width: 4px; }
        #messages::-webkit-scrollbar-track { background: transparent; }
        #messages::-webkit-scrollbar-thumb { background: var(--text-faint); border-radius: 4px; }

        /* Welcome screen */
        #welcome {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          height: 100%;
          text-align: center;
          padding: 40px;
          gap: 20px;
          animation: fadeUp 0.6s ease both;
        }

        .welcome-orb {
          width: 80px; height: 80px;
          background: linear-gradient(135deg, var(--accent), #fb923c);
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 36px;
          box-shadow: 0 0 50px var(--accent-glow), 0 0 100px rgba(249,115,22,0.1);
          animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {
          0%, 100% { box-shadow: 0 0 40px var(--accent-glow), 0 0 80px rgba(249,115,22,0.08); }
          50% { box-shadow: 0 0 60px rgba(249,115,22,0.4), 0 0 120px rgba(249,115,22,0.15); }
        }

        .welcome-title {
          font-family: var(--font-display);
          font-size: 36px;
          color: var(--text);
          letter-spacing: -1px;
        }
        .welcome-title em { color: var(--accent2); font-style: italic; }

        .welcome-sub {
          font-size: 15px;
          color: var(--text-dim);
          max-width: 420px;
          line-height: 1.7;
        }

        .suggestions {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 10px;
          margin-top: 10px;
          max-width: 520px;
          width: 100%;
        }

        .suggestion {
          padding: 14px 16px;
          background: var(--surface);
          border: 1px solid var(--border);
          border-radius: var(--r-sm);
          font-size: 13px;
          color: var(--text-dim);
          cursor: pointer;
          text-align: left;
          transition: all 0.2s;
          line-height: 1.4;
        }
        .suggestion:hover {
          border-color: var(--accent);
          color: var(--text);
          background: rgba(249,115,22,0.06);
          transform: translateY(-1px);
        }
        .suggestion strong { display: block; color: var(--text); margin-bottom: 3px; font-size: 12px; }

        /* Message rows */
        .msg-row {
          padding: 4px 28px;
          display: flex;
          flex-direction: column;
          animation: fadeUp 0.35s ease both;
          max-width: 900px;
          margin: 0 auto;
          width: 100%;
        }

        @keyframes fadeUp {
          from { opacity: 0; transform: translateY(14px); }
          to   { opacity: 1; transform: translateY(0); }
        }

        .msg-meta {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 6px;
          font-size: 11px;
          color: var(--text-faint);
          font-family: var(--font-mono);
        }

        .msg-avatar {
          width: 22px; height: 22px;
          border-radius: 6px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 11px;
          flex-shrink: 0;
        }
        .msg-avatar.user { background: var(--user-bg); border: 1px solid var(--user-border); }
        .msg-avatar.ai {
          background: linear-gradient(135deg, var(--accent), #fb923c);
          box-shadow: 0 0 8px var(--accent-glow);
        }

        .msg-bubble {
          padding: 14px 18px;
          border-radius: var(--r);
          font-size: 14.5px;
          line-height: 1.7;
          position: relative;
          max-width: 82%;
        }

        .msg-bubble.user {
          background: var(--user-bg);
          border: 1px solid var(--user-border);
          align-self: flex-end;
          border-bottom-right-radius: 4px;
          color: #c8c4f8;
        }
        .msg-bubble.user .msg-meta { justify-content: flex-end; }

        .msg-bubble.ai {
          background: var(--ai-bg);
          border: 1px solid var(--ai-border);
          align-self: flex-start;
          border-bottom-left-radius: 4px;
          color: var(--text);
        }

        /* Message row layout for user vs AI */
        .msg-row.user { align-items: flex-end; }
        .msg-row.ai { align-items: flex-start; }
        .msg-row.user .msg-meta { flex-direction: row-reverse; }

        /* Code blocks */
        .msg-bubble pre {
          background: rgba(0,0,0,0.4);
          border: 1px solid var(--border);
          border-radius: 8px;
          padding: 14px;
          overflow-x: auto;
          margin: 12px 0;
          font-family: var(--font-mono);
          font-size: 13px;
          line-height: 1.6;
        }
        .msg-bubble code {
          font-family: var(--font-mono);
          font-size: 13px;
          background: rgba(249,115,22,0.1);
          padding: 2px 6px;
          border-radius: 4px;
          color: var(--accent2);
        }
        .msg-bubble pre code { background: transparent; padding: 0; color: #c9d1d9; }

        /* Typing indicator */
        .typing-indicator {
          display: flex;
          align-items: center;
          gap: 4px;
          padding: 14px 18px;
          background: var(--ai-bg);
          border: 1px solid var(--ai-border);
          border-radius: var(--r);
          border-bottom-left-radius: 4px;
          width: fit-content;
        }
        .typing-dot {
          width: 6px; height: 6px;
          background: var(--accent);
          border-radius: 50%;
          animation: typingBounce 1.2s ease infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
          0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
          30% { transform: translateY(-6px); opacity: 1; }
        }

        /* Usage footer */
        .msg-usage {
          font-size: 10px;
          color: var(--text-faint);
          font-family: var(--font-mono);
          margin-top: 6px;
          display: flex;
          gap: 10px;
          padding-left: 4px;
        }
        .usage-badge {
          background: rgba(249,115,22,0.06);
          border: 1px solid var(--border);
          padding: 2px 7px;
          border-radius: 20px;
        }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” INPUT AREA â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        #input-area {
          padding: 16px 28px 22px;
          border-top: 1px solid var(--border);
          flex-shrink: 0;
          background: rgba(10,10,15,0.9);
          backdrop-filter: blur(12px);
        }

        .input-wrap {
          max-width: 860px;
          margin: 0 auto;
          position: relative;
          background: var(--surface);
          border: 1px solid var(--border2);
          border-radius: 14px;
          display: flex;
          align-items: flex-end;
          gap: 0;
          transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-wrap:focus-within {
          border-color: var(--accent);
          box-shadow: 0 0 0 3px var(--accent-glow), 0 4px 24px rgba(0,0,0,0.3);
        }

        #userInput {
          flex: 1;
          background: transparent;
          border: none;
          outline: none;
          color: var(--text);
          font-family: var(--font-body);
          font-size: 14.5px;
          line-height: 1.6;
          padding: 14px 16px;
          resize: none;
          max-height: 200px;
          min-height: 52px;
          overflow-y: auto;
          scrollbar-width: thin;
        }
        #userInput::placeholder { color: var(--text-faint); }

        .input-controls {
          display: flex;
          align-items: flex-end;
          padding: 8px 10px;
          gap: 6px;
        }

        .param-mini {
          display: flex;
          flex-direction: column;
          gap: 2px;
          font-size: 10px;
          color: var(--text-faint);
          padding: 0 4px;
          border-right: 1px solid var(--border);
          margin-right: 2px;
        }
        .param-mini input[type=range] {
          width: 70px;
          accent-color: var(--accent);
          cursor: pointer;
        }
        .param-mini span { font-family: var(--font-mono); color: var(--accent2); }

        #sendBtn {
          width: 38px; height: 38px;
          background: linear-gradient(135deg, var(--accent), #fb923c);
          border: none;
          border-radius: 10px;
          color: white;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 16px;
          transition: all 0.2s;
          box-shadow: 0 2px 12px rgba(249,115,22,0.3);
          flex-shrink: 0;
        }
        #sendBtn:hover { transform: scale(1.05); box-shadow: 0 4px 18px rgba(249,115,22,0.5); }
        #sendBtn:active { transform: scale(0.97); }
        #sendBtn:disabled {
          background: var(--surface2);
          box-shadow: none;
          cursor: not-allowed;
          transform: none;
          color: var(--text-faint);
        }

        #sendBtn svg.spinner {
          animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .input-hint {
          text-align: center;
          font-size: 11px;
          color: var(--text-faint);
          margin-top: 10px;
          max-width: 860px;
          margin-left: auto;
          margin-right: auto;
        }
        .input-hint kbd {
          background: var(--surface2);
          border: 1px solid var(--border);
          border-radius: 4px;
          padding: 1px 6px;
          font-family: var(--font-mono);
          font-size: 10px;
          color: var(--text-dim);
        }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” ERROR TOAST â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        #toast {
          position: fixed;
          bottom: 100px;
          left: 50%;
          transform: translateX(-50%) translateY(20px);
          background: rgba(248,113,113,0.12);
          border: 1px solid rgba(248,113,113,0.3);
          color: var(--error);
          padding: 12px 20px;
          border-radius: 10px;
          font-size: 13px;
          font-family: var(--font-mono);
          backdrop-filter: blur(10px);
          opacity: 0;
          pointer-events: none;
          transition: all 0.3s ease;
          z-index: 100;
          max-width: 400px;
          text-align: center;
        }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” SCROLL TO BOTTOM BTN â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        #scrollBtn {
          position: absolute;
          bottom: 130px;
          right: 28px;
          width: 36px; height: 36px;
          background: var(--surface2);
          border: 1px solid var(--border2);
          border-radius: 50%;
          color: var(--text-dim);
          cursor: pointer;
          display: none;
          align-items: center;
          justify-content: center;
          font-size: 14px;
          transition: all 0.2s;
          z-index: 10;
        }
        #scrollBtn:hover { color: var(--text); border-color: var(--accent); background: rgba(249,115,22,0.1); }
        #scrollBtn.visible { display: flex; }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” RESPONSIVE â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        @media (max-width: 700px) {
          #app { grid-template-columns: 1fr; }
          #sidebar { display: none; }
          .msg-row { padding: 4px 14px; }
          #input-area { padding: 12px 14px 16px; }
          .suggestions { grid-template-columns: 1fr; }
        }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” SYSTEM MSG â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        .system-toggle {
          max-width: 860px;
          margin: 0 auto 8px;
          padding: 0 28px;
          display: flex;
          align-items: center;
          gap: 8px;
          font-size: 11px;
          color: var(--text-faint);
          cursor: pointer;
        }
        .system-toggle:hover { color: var(--text-dim); }
        #systemPromptArea {
          max-width: 860px;
          margin: 0 auto 10px;
          padding: 0 28px;
          display: none;
        }
        #systemPromptArea textarea {
          width: 100%;
          background: var(--surface);
          border: 1px solid var(--border);
          border-radius: var(--r-sm);
          color: var(--text-dim);
          font-family: var(--font-mono);
          font-size: 12px;
          padding: 10px 12px;
          resize: vertical;
          min-height: 70px;
          outline: none;
          transition: border-color 0.2s;
        }
        #systemPromptArea textarea:focus { border-color: var(--accent); }
        #systemPromptArea textarea::placeholder { color: var(--text-faint); }
    </style>
</head>
<body>

<div id="app">
    <!-- â•â•â• SIDEBAR â•â•â• -->
    <aside id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">âš¡</div>
                <span class="logo-text">Neuron</span>
            </div>
            <div class="logo-sub">Local AI Interface</div>
        </div>

        <button class="new-chat-btn" onclick="newChat()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            New conversation
        </button>

        <div class="sidebar-section">Recent</div>
        <div class="chat-list" id="chatList"></div>

        <div class="sidebar-footer">
            <div class="model-selector-label">Active Model</div>
            <div class="model-selector-wrap">
                <select id="modelSelect">
                    <option value="">Loading modelsâ€¦</option>
                </select>
            </div>
            <div class="status-bar">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Connectingâ€¦</span>
            </div>
        </div>
    </aside>

    <!-- â•â•â• MAIN â•â•â• -->
    <main id="main">
        <!-- Top bar -->
        <div id="topbar">
            <div class="topbar-title">
                Chat with <span id="topbarModel">local model</span>
            </div>
            <div class="topbar-actions">
                <button class="icon-btn" onclick="clearChat()" title="Clear conversation">
                    <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                </button>
                <button class="icon-btn" onclick="exportChat()" title="Export conversation">
                    <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Messages -->
        <div id="messages">
            <div id="welcome">
                <div class="welcome-orb">âš¡</div>
                <h1 class="welcome-title">Hello, I'm <em>Neuron</em></h1>
                <p class="welcome-sub">Your local AI assistant, running privately on your machine. No cloud, no tracking â€” just intelligence at your fingertips.</p>
                <div class="suggestions">
                    <button class="suggestion" onclick="sendSuggestion(this)">
                        <strong>âœ¦ Explain a concept</strong>
                        Explain quantum entanglement in simple terms
                    </button>
                    <button class="suggestion" onclick="sendSuggestion(this)">
                        <strong>âœ¦ Write code</strong>
                        Write a Python script to scrape a webpage
                    </button>
                    <button class="suggestion" onclick="sendSuggestion(this)">
                        <strong>âœ¦ Creative writing</strong>
                        Write a short noir detective story opening
                    </button>
                    <button class="suggestion" onclick="sendSuggestion(this)">
                        <strong>âœ¦ Summarize</strong>
                        What are the key principles of clean code?
                    </button>
                </div>
            </div>
        </div>

        <!-- Scroll to bottom -->
        <button id="scrollBtn" onclick="scrollToBottom(true)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <polyline points="6 9 12 15 18 9"/>
            </svg>
        </button>

        <!-- Input -->
        <div id="input-area">
            <!-- System prompt toggle -->
            <div class="system-toggle" onclick="toggleSystem()">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/>
                </svg>
                <span id="systemLabel">Set system prompt</span>
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="sysArrow">
                    <polyline points="6 9 12 15 18 9"/>
                </svg>
            </div>
            <div id="systemPromptArea">
                <textarea id="systemPrompt" placeholder="You are a helpful AI assistantâ€¦" rows="3"></textarea>
            </div>

            <div class="input-wrap">
        <textarea
                id="userInput"
                placeholder="Message Neuronâ€¦"
                rows="1"
                onkeydown="handleKey(event)"
                oninput="autoResize(this)"
        ></textarea>
                <div class="input-controls">
                    <div class="param-mini">
                        <label>Temp <span id="tempVal">0.7</span></label>
                        <input type="range" min="0" max="2" step="0.05" value="0.7" id="tempSlider" oninput="document.getElementById('tempVal').textContent=this.value" />
                    </div>
                    <button id="sendBtn" onclick="sendMessage()" title="Send (Enter)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" id="sendIcon">
                            <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="input-hint">
                Press <kbd>Enter</kbd> to send Â· <kbd>Shift+Enter</kbd> for new line
            </div>
        </div>
    </main>
</div>

<div id="toast"></div>

<script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let conversations = JSON.parse(localStorage.getItem('neuron_convs') || '[]');
    let currentConvId = null;
    let messages = []; // [{role, content}]
    let isLoading = false;
    let systemOpen = false;

    const API_BASE = '/api';

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  INIT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.addEventListener('load', async () => {
      renderConvList();
      await checkHealth();
      await loadModels();
      setupScrollListener();
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  HEALTH & MODELS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function checkHealth() {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');
      try {
        const r = await fetch(`${API_BASE}/health`);
        if (r.ok) {
          dot.className = 'status-dot online';
          text.textContent = 'Connected to LLM server';
        } else {
          throw new Error();
        }
      } catch {
        dot.className = 'status-dot error';
        text.textContent = 'LLM server unreachable';
      }
    }

    async function loadModels() {
      const sel = document.getElementById('modelSelect');
      try {
        const r = await fetch(`${API_BASE}/models`);
        const data = await r.json();
        if (Array.isArray(data) && data.length > 0) {
          sel.innerHTML = data.map(m => `<option value="${m.id}">${m.id}</option>`).join('');
        } else {
          sel.innerHTML = '<option value="local-model">local-model</option>';
        }
      } catch {
        sel.innerHTML = '<option value="local-model">local-model (default)</option>';
      }
      updateTopbarModel();
      sel.addEventListener('change', updateTopbarModel);
    }

    function updateTopbarModel() {
      const sel = document.getElementById('modelSelect');
      document.getElementById('topbarModel').textContent = sel.value || 'local model';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  CONVERSATIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function newChat() {
      currentConvId = null;
      messages = [];
      showWelcome();
      renderConvList();
      document.getElementById('userInput').focus();
    }

    function clearChat() {
      messages = [];
      showWelcome();
      if (currentConvId !== null) {
        const c = conversations.find(c => c.id === currentConvId);
        if (c) { c.messages = []; saveConvs(); }
      }
    }

    function showWelcome() {
      const msgs = document.getElementById('messages');
      msgs.innerHTML = `
        <div id="welcome">
          <div class="welcome-orb">âš¡</div>
          <h1 class="welcome-title">Hello, I'm <em>Neuron</em></h1>
          <p class="welcome-sub">Your local AI assistant, running privately on your machine. No cloud, no tracking â€” just intelligence at your fingertips.</p>
          <div class="suggestions">
            <button class="suggestion" onclick="sendSuggestion(this)"><strong>âœ¦ Explain a concept</strong>Explain quantum entanglement in simple terms</button>
            <button class="suggestion" onclick="sendSuggestion(this)"><strong>âœ¦ Write code</strong>Write a Python script to scrape a webpage</button>
            <button class="suggestion" onclick="sendSuggestion(this)"><strong>âœ¦ Creative writing</strong>Write a short noir detective story opening</button>
            <button class="suggestion" onclick="sendSuggestion(this)"><strong>âœ¦ Summarize</strong>What are the key principles of clean code?</button>
          </div>
        </div>`;
    }

    function saveConvs() {
      localStorage.setItem('neuron_convs', JSON.stringify(conversations.slice(-40)));
    }

    function renderConvList() {
      const list = document.getElementById('chatList');
      if (!conversations.length) {
        list.innerHTML = '<div style="padding:10px 12px;font-size:12px;color:var(--text-faint)">No conversations yet</div>';
        return;
      }
      list.innerHTML = conversations.slice().reverse().map(c => `
        <div class="chat-item ${c.id === currentConvId ? 'active' : ''}" onclick="loadConv(${c.id})">
          <span class="ci-icon">ğŸ’¬</span>
          <span class="ci-label">${escHtml(c.title)}</span>
        </div>`).join('');
    }

    function loadConv(id) {
      const c = conversations.find(c => c.id === id);
      if (!c) return;
      currentConvId = id;
      messages = [...c.messages];
      const msgs = document.getElementById('messages');
      msgs.innerHTML = '';
      messages.forEach(m => appendBubble(m.role, m.content));
      scrollToBottom();
      renderConvList();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  SEND MESSAGE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function sendMessage(text) {
      if (isLoading) return;
      const input = document.getElementById('userInput');
      const content = (text || input.value).trim();
      if (!content) return;

      // Clear welcome
      const welcome = document.getElementById('welcome');
      if (welcome) welcome.remove();

      input.value = '';
      input.style.height = '';
      messages.push({ role: 'user', content });
      appendBubble('user', content);
      scrollToBottom();

      // Init conversation
      if (currentConvId === null) {
        currentConvId = Date.now();
        const title = content.slice(0, 48) + (content.length > 48 ? 'â€¦' : '');
        conversations.push({ id: currentConvId, title, messages: [] });
        renderConvList();
      }

      setLoading(true);
      const typingId = showTyping();

      try {
        const systemContent = document.getElementById('systemPrompt').value.trim();
        const reqMessages = systemContent
          ? [{ role: 'system', content: systemContent }, ...messages]
          : messages;

        const model = document.getElementById('modelSelect').value || 'local-model';
        const temp = parseFloat(document.getElementById('tempSlider').value);

        const res = await fetch(`${API_BASE}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages: reqMessages, model, temperature: temp })
        });

        removeTyping(typingId);

        if (!res.ok) {
          const err = await res.json().catch(() => ({ error: 'Unknown error' }));
          throw new Error(err.error || `HTTP ${res.status}`);
        }

        const data = await res.json();
        const reply = data.message?.content || '(empty response)';
        messages.push({ role: 'assistant', content: reply });

        appendBubble('ai', reply, data.usage);
        scrollToBottom();

        // Save
        const c = conversations.find(c => c.id === currentConvId);
        if (c) { c.messages = [...messages]; saveConvs(); }

        renderConvList();

      } catch (e) {
        removeTyping(typingId);
        showToast('âš  ' + e.message);
      } finally {
        setLoading(false);
      }
    }

    function sendSuggestion(btn) {
      const text = btn.innerText.replace(/âœ¦.*\n/, '').trim();
      sendMessage(text);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  UI HELPERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function appendBubble(role, content, usage) {
      const msgs = document.getElementById('messages');
      const isUser = role === 'user';

      const row = document.createElement('div');
      row.className = `msg-row ${isUser ? 'user' : 'ai'}`;

      const meta = document.createElement('div');
      meta.className = 'msg-meta';
      meta.innerHTML = isUser
        ? `<span>${now()}</span><div class="msg-avatar user">ğŸ‘¤</div>`
        : `<div class="msg-avatar ai">âš¡</div><span>Neuron Â· ${now()}</span>`;

      const bubble = document.createElement('div');
      bubble.className = `msg-bubble ${isUser ? 'user' : 'ai'}`;
      bubble.innerHTML = formatContent(content);

      row.appendChild(meta);
      row.appendChild(bubble);

      if (usage && (usage.total_tokens > 0)) {
        const u = document.createElement('div');
        u.className = 'msg-usage';
        u.innerHTML = `
          <span class="usage-badge">â†‘ ${usage.prompt_tokens} tokens</span>
          <span class="usage-badge">â†“ ${usage.completion_tokens} tokens</span>
          <span class="usage-badge">âˆ‘ ${usage.total_tokens} total</span>`;
        row.appendChild(u);
      }

      msgs.appendChild(row);
    }

    function formatContent(text) {
      // Code blocks
      text = text.replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) =>
        `<pre><code>${escHtml(code.trim())}</code></pre>`);
      // Inline code
      text = text.replace(/`([^`]+)`/g, (_, c) => `<code>${escHtml(c)}</code>`);
      // Bold
      text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      // Italic
      text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
      // Line breaks
      text = text.replace(/\n/g, '<br>');
      return text;
    }

    function showTyping() {
      const id = 'typing-' + Date.now();
      const msgs = document.getElementById('messages');
      const row = document.createElement('div');
      row.className = 'msg-row ai';
      row.id = id;
      row.innerHTML = `
        <div class="msg-meta"><div class="msg-avatar ai">âš¡</div><span>Neuron Â· thinkingâ€¦</span></div>
        <div class="typing-indicator">
          <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
        </div>`;
      msgs.appendChild(row);
      scrollToBottom();
      return id;
    }

    function removeTyping(id) {
      document.getElementById(id)?.remove();
    }

    function setLoading(state) {
      isLoading = state;
      const btn = document.getElementById('sendBtn');
      btn.disabled = state;
      btn.innerHTML = state
        ? `<svg class="spinner" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>`
        : `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>`;
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 4000);
    }

    function now() {
      return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function escHtml(s) {
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  SCROLL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function scrollToBottom(smooth) {
      const msgs = document.getElementById('messages');
      msgs.scrollTo({ top: msgs.scrollHeight, behavior: smooth ? 'smooth' : 'auto' });
    }

    function setupScrollListener() {
      const msgs = document.getElementById('messages');
      const btn = document.getElementById('scrollBtn');
      msgs.addEventListener('scroll', () => {
        const nearBottom = msgs.scrollHeight - msgs.scrollTop - msgs.clientHeight < 120;
        btn.classList.toggle('visible', !nearBottom);
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  SYSTEM PROMPT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function toggleSystem() {
      systemOpen = !systemOpen;
      document.getElementById('systemPromptArea').style.display = systemOpen ? 'block' : 'none';
      document.getElementById('systemLabel').textContent = systemOpen ? 'Hide system prompt' : 'Set system prompt';
      document.getElementById('sysArrow').style.transform = systemOpen ? 'rotate(180deg)' : '';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  EXPORT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function exportChat() {
      if (!messages.length) { showToast('Nothing to export yet'); return; }
      const text = messages.map(m => `[${m.role.toUpperCase()}]\n${m.content}`).join('\n\n---\n\n');
      const blob = new Blob([text], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `neuron-chat-${Date.now()}.txt`;
      a.click();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  INPUT HANDLING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function handleKey(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    }

    function autoResize(el) {
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 200) + 'px';
    }
</script>
</body>
</html>
